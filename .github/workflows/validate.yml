name: Validate | Workflow Files | Job Pipeline

# IMPORTANT: No paths filter - required checks must run on every PR
# Internal change detection handles the no-op case
on:
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to comment on'
        required: false
        type: string
      job_id:
        description: 'Supabase Job UUID for status updates'
        required: false
        type: string
  # Also serves as reusable workflow for other repos
  workflow_call:
    inputs:
      repo_name:
        description: 'Repository name (e.g., mixplaces_control_ui)'
        required: true
        type: string
      validation_status:
        description: 'Validation result: VALIDATED | REJECTED | SKIPPED'
        required: true
        type: string
      validation_reason:
        description: 'Reason for status (optional, used for REJECTED)'
        required: false
        type: string
        default: ''
      pr_number:
        description: 'PR number to comment on'
        required: false
        type: string
        default: ''
      job_id:
        description: 'Job UUID for webhook signaling'
        required: false
        type: string
        default: ''
    secrets:
      N8N_BASE_URL:
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================================
  # REPO-SPECIFIC VALIDATION (runs on pull_request and workflow_dispatch)
  # ============================================================================
  validate:
    name: Validate Workflow Files
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    outputs:
      status: ${{ steps.result.outputs.status }}
      reason: ${{ steps.result.outputs.reason }}
      job_id: ${{ steps.job.outputs.job_id }}
      pr_number: ${{ steps.pr_number.outputs.number }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve Job ID
        id: job
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          else
            if [ -n "${{ inputs.job_id }}" ]; then
              echo "job_id=${{ inputs.job_id }}" >> $GITHUB_OUTPUT
              exit 0
            fi
            BRANCH="${{ github.ref_name }}"
          fi
          
          JOB_ID=$(echo "$BRANCH" | sed -n 's|^job/||p')
          
          if [ -z "$JOB_ID" ]; then
            echo "::notice::Non-job branch detected: $BRANCH (webhooks will be skipped)"
          else
            echo "Resolved job_id: $JOB_ID"
          fi
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Check for Source Changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(yml|yaml|md|txt)$' || echo "")
          else
            CHANGED="workflow_dispatch_always_validate"
          fi
          
          if [ -z "$CHANGED" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "✓ No source files changed - fast pass"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Source files to validate:"
            echo "$CHANGED" | head -20
          fi

      - name: Fast Pass (No Changes)
        if: steps.changes.outputs.skip == 'true'
        run: |
          echo "## ✓ Validation Skipped - No Source Changes" >> $GITHUB_STEP_SUMMARY

      - name: Signal Validation Started
        if: steps.job.outputs.job_id != '' && steps.changes.outputs.skip != 'true'
        run: |
          curl -X POST "${{ secrets.N8N_BASE_URL }}/webhook/validation-result" \
            -H "Content-Type: application/json" \
            -d '{
              "job_id": "${{ steps.job.outputs.job_id }}",
              "repo": ".github",
              "pr_number": ${{ github.event.pull_request.number || inputs.pr_number || 0 }},
              "status": "VALIDATING"
            }'

      - name: Setup Python
        if: steps.changes.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate YAML Syntax
        id: yaml_check
        if: steps.changes.outputs.skip != 'true'
        run: |
          set -o pipefail
          pip install yamllint --quiet
          
          if yamllint -d relaxed .github/workflows/*.yml 2>&1 | tee yaml-output.txt; then
            echo "✅ YAML syntax valid" >> $GITHUB_STEP_SUMMARY
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ YAML syntax errors" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine Result
        id: result
        run: |
          if [ "${{ steps.changes.outputs.skip }}" == "true" ]; then
            echo "status=SKIPPED" >> $GITHUB_OUTPUT
            echo "reason=No source files changed" >> $GITHUB_OUTPUT
          elif [ "${{ steps.yaml_check.outputs.passed }}" == "false" ]; then
            echo "status=REJECTED" >> $GITHUB_OUTPUT
            echo "reason=YAML syntax errors in workflow files" >> $GITHUB_OUTPUT
          else
            echo "status=VALIDATED" >> $GITHUB_OUTPUT
          fi

      - name: Get PR Number
        id: pr_number
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ inputs.pr_number }}" ]; then
            echo "number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (REJECTED)
        if: steps.pr_number.outputs.number != '' && steps.result.outputs.status == 'REJECTED'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = parseInt('${{ steps.pr_number.outputs.number }}', 10);
            let body = '## ❌ Validation: REJECTED\n\n';
            body += '**Reason:** ${{ steps.result.outputs.reason }}\n\n';
            if (fs.existsSync('yaml-output.txt')) {
              const yamlOutput = fs.readFileSync('yaml-output.txt', 'utf8');
              body += '### YAML Errors\n\n```\n' + yamlOutput.slice(-2000) + '\n```\n\n';
            }
            body += '---\n*Automated validation by GitHub Actions*';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # Post-validation reporting for .github repo itself
  report-self:
    name: Report Result (Self)
    needs: validate
    if: always() && (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      - name: Normalize Status
        id: normalize
        run: |
          STATUS="${{ needs.validate.outputs.status }}"
          REASON="${{ needs.validate.outputs.reason }}"
          if [ "$STATUS" = "SKIPPED" ]; then
            STATUS="VALIDATED"
            REASON="No source changes (fast pass)"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

      - name: Signal Validation Result
        if: needs.validate.outputs.job_id != ''
        run: |
          curl -sf -X POST "${{ secrets.N8N_BASE_URL }}/webhook/validation-result" \
            -H "Content-Type: application/json" \
            -d '{
              "job_id": "${{ needs.validate.outputs.job_id }}",
              "repo": ".github",
              "pr_number": ${{ needs.validate.outputs.pr_number || 0 }},
              "status": "${{ steps.normalize.outputs.status }}",
              "reason": "${{ steps.normalize.outputs.reason }}"
            }'

      - name: Comment on PR (VALIDATED)
        if: needs.validate.outputs.pr_number != '' && steps.normalize.outputs.status == 'VALIDATED'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ needs.validate.outputs.pr_number }}', 10);
            if (isNaN(prNumber) || prNumber <= 0) return;
            const body = '## ✅ Validation: VALIDATED\n\nAll checks passed.\n\n---\n*Automated validation by GitHub Actions*';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Fail if REJECTED
        if: steps.normalize.outputs.status == 'REJECTED'
        run: exit 1

  # ============================================================================
  # REUSABLE WORKFLOW (called by other repos via workflow_call)
  # ============================================================================
  report:
    name: Report Validation Result
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_call'
    
    steps:
      - name: Normalize Status
        id: normalize
        run: |
          STATUS="${{ inputs.validation_status }}"
          REASON="${{ inputs.validation_reason }}"
          if [ "$STATUS" = "SKIPPED" ]; then
            STATUS="VALIDATED"
            REASON="No source changes (fast pass)"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

      - name: Signal Validation Result
        if: inputs.job_id != ''
        run: |
          curl -sf -X POST "${{ secrets.N8N_BASE_URL }}/webhook/validation-result" \
            -H "Content-Type: application/json" \
            -d '{
              "job_id": "${{ inputs.job_id }}",
              "repo": "${{ inputs.repo_name }}",
              "pr_number": ${{ inputs.pr_number || 0 }},
              "status": "${{ steps.normalize.outputs.status }}",
              "reason": "${{ steps.normalize.outputs.reason }}"
            }'

      - name: Comment on PR (VALIDATED)
        if: inputs.pr_number != '' && steps.normalize.outputs.status == 'VALIDATED'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}', 10);
            if (isNaN(prNumber) || prNumber <= 0) return;
            const body = '## ✅ Validation: VALIDATED\n\nAll checks passed.\n\n---\n*Automated validation by GitHub Actions*';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: '${{ inputs.repo_name }}',
              issue_number: prNumber,
              body: body
            });

      - name: Fail if REJECTED
        if: steps.normalize.outputs.status == 'REJECTED'
        run: exit 1
